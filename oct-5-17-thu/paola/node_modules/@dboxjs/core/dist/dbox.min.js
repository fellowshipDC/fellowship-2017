!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("cartodb")):"function"==typeof define&&define.amd?define(["exports","cartodb"],n):n(t.dbox=t.dbox||{},t.cartodb)}(this,function(t,n){"use strict";function e(){function t(){}return t.query=function(t,e){new n.SQL({user:t.cartodb.user}).execute(t.cartodb.sql).done(function(n){var i=n.rows;t.parser&&(i=n.rows.map(t.parser)),e(null,i)}).error(function(t){e(t,null)})},t}var i=function(t){function n(t){var n=this,e={size:{width:800,height:600,margin:{left:0,right:0,top:0,bottom:0}}};n._config=t?_.cloneDeep(t):e,n._data=[],n._margin=n._config.size.margin,n._width=n._config.size.width-n._margin.left-n._margin.right,n._height=n._config.size.height-n._margin.top-n._margin.bottom,n._svg="",n._scales={},n._axes={},n.layers=[]}return n.prototype.config=function(t){var n=this;return n._config=_.cloneDeep(t),n},n.prototype.size=function(t){var n=this;return t&&(t.margin&&(t.margin.left==Number(t.margin.left)&&(n._config.size.margin.left=t.margin.left,n._margin.left=t.margin.left),t.margin.right==Number(t.margin.right)&&(n._config.size.margin.right=t.margin.right,n._margin.right=t.margin.right),t.margin.top==Number(t.margin.top)&&(n._config.size.margin.top=t.margin.top,n._margin.top=t.margin.top),t.margin.bottom==Number(t.margin.bottom)&&(n._config.size.margin.bottom=t.margin.bottom,n._margin.bottom=t.margin.bottom)),t.width==Number(t.width)&&(n._config.size.width=t.width,n._width=t.width),t.height==Number(t.height)&&(n._config.size.height=t.height,n._height=t.height)),n},n.prototype.grid=function(t){var n=this;return n._config.grid=!!t,n},n.prototype.bindTo=function(t){var n=this;return n._config.bindTo=t,n},n.prototype.data=function(t){var n=this;return n._config.data=t,n},n.prototype.layer=function(t,n){var e,i=this,r=n||i._config;if(void 0!==t||null!==t)return e=t(r),e.chart(i),i.layers.push(e),e},n.prototype.getLayer=function(t){return this.layers[t]},n.prototype.draw=function(){var t,n=this;return n._scales=n.scales(),n._axes=n.axes(),t=n.loadData(),t.await(function(t,e){if(t)throw t;n._data=e,n.drawSVG(),n.drawGraphs(),n.drawAxes(),n._config.events&&n._config.events.load&&n.dispatch.on("load.chart",n._config.events.load(n))}),n},n.prototype.scales=function(){var t=this,n={};if(t._config.xAxis&&t._config.xAxis.scale)switch(t._config.xAxis.scale){case"linear":n.x=d3.scaleLinear().range([0,t._width]);break;case"time":n.x=d3.scaleTime().range([0,t._width]);break;case"ordinal":n.x=d3.scaleOrdinal().range([0,t._width],.1);break;case"band":n.x=d3.scaleBand().rangeRound([0,t._width]).padding(.1);break;case"quantile":n.x=d3.scaleOrdinal().range([0,t._width],.1),n.q=d3.scaleQuantile().range(d3.range(t._config.xAxis.buckets));break;default:n.x=d3.scaleLinear().range([0,t._width])}else n.x=d3.scaleLinear().range([0,t._width]);if(t._config.yAxis&&t._config.yAxis.scale)switch(t._config.yAxis.scale){case"linear":n.y=d3.scaleLinear().range([t._height,0]);break;case"time":n.y=d3.scaleTime().range([t._height,0]);break;case"ordinal":n.y=d3.scaleOrdinal().range([t._height,0],.1);break;case"band":n.y=d3.scaleBand().rangeRound([t._height,0]).padding(.1);break;case"quantile":n.y=d3.scaleOrdinal().range([0,t._width],.1),n.q=d3.scaleQuantile().range(d3.range(t._config.yAxis.buckets));break;default:n.y=d3.scaleLinear().range([t._height,0])}else n.y=d3.scaleLinear().range([t._height,0]);return n.color=d3.scaleOrdinal(d3.schemeCategory10),n},n.prototype.generateScale=function(t,n){var e={};if(!n.range)throw"Range is not defined";var i=d3.extent(t,function(t){return+t[n.column]});if(n.minZero&&(i=[0,d3.max(t,function(t){return+t[n.column]})]),n.type)switch(n.type){case"linear":e=d3.scaleLinear().rangeRound(n.range).domain(i);break;case"time":e=d3.scaleTime().range(n.range).domain(i);break;case"ordinal":e=d3.scaleBand().rangeRound(n.range).padding(.1).domain(t.map(function(t){return t[n.column]}));break;case"quantile":e=d3.scaleBand().rangeRound(n.range).padding(.1).domain(t.map(function(t){return t[n.column]})),n.bins||(n.bins=10),e=d3.scaleQuantile().range(d3.range(n.bins));break;default:e=d3.scaleLinear().rangeRound(n.range).domain(i)}else e=d3.scaleLinear().rangeRound(n.range).domain(i);return e},n.prototype.axes=function(){var t=this,n={};if(n.x=d3.axisBottom(t._scales.x),n.y=d3.axisLeft(t._scales.y),t._config.yAxis&&t._config.yAxis.ticks&&!0===t._config.yAxis.ticks.enabled&&t._config.yAxis.ticks.style)switch(t._config.yAxis.ticks.style){case"straightLine":n.y.tickSize(-t._width,0)}return t._config.yAxis&&t._config.yAxis.ticks&&t._config.yAxis.ticks.format&&n.y.tickFormat(t._config.yAxis.ticks.format),n},n.prototype.loadData=function(){var t,n=this;return n._config.data.tsv&&(t=d3.queue().defer(d3.tsv,n._config.data.tsv)),n._config.data.json&&(t=d3.queue().defer(d3.json,n._config.data.json)),n._config.data.csv&&(t=d3.queue().defer(d3.csv,n._config.data.csv)),n._config.data.raw&&(t=d3.queue().defer(n.mapData,n._config.data.raw)),n._config.data.cartodb&&(t=d3.queue().defer(e.query,n._config.data)),n._config.plotOptions&&n._config.plotOptions.bars&&n._config.plotOptions.bars.averageLines&&Array.isArray(n._config.plotOptions.bars.averageLines)&&n._config.plotOptions.bars.averageLines.length>0&&n._config.plotOptions.bars.averageLines.forEach(function(n){n.data.cartodb&&t.defer(e.query,n.data)}),t},n.prototype.drawSVG=function(){var t=this;if(d3.select(t._config.bindTo).select("svg").remove(),d3.select(t._config.bindTo).html(""),t._config.template&&d3.select(t._config.bindTo).classed(t._config.template,!0),t._config.chart&&t._config.chart.title&&d3.select(t._config.bindTo).append("div").attr("class","chart-title").html(t._config.chart.title),t._config.legend&&!0===t._config.legend.enable&&"top"===t._config.legend.position){var n=d3.select(t._config.bindTo).append("div").attr("class","chart-legend-top"),e="";e+="<div style='background-color:#E2E2E1;text-align:center;height: 40px;margin: 0px 15px'>",t._config.legend.categories.forEach(function(t){e+="<div class='dbox-legend-category-title' style='margin:0 20px;'><span class='dbox-legend-category-color' style='background-color:"+t.color+";'> </span><span style='height: 10px;float: left;margin: 10px 5px 5px 5px;border-radius: 50%;'>"+t.title+"</span></div>"}),e+="</div>",n.html(e)}t._svg=d3.select(t._config.bindTo).append("svg").style("font-size",t._config.chart&&t._config.chart["font-size"]?t._config.chart["font-size"]:"12px").attr("width",t._width+t._margin.left+t._margin.right).attr("height",t._height+t._margin.top+t._margin.bottom).append("g").attr("transform","translate("+t._margin.left+","+t._margin.top+")"),t._config.chart&&t._config.chart.background&&t._config.chart.background.color&&d3.select(t._config.bindTo+" svg").style("background-color",t._config.chart.background.color);d3.select(t._config.bindTo).append("div").attr("class","chart-legend-bottom")},n.prototype.drawGrid=function(){return this},n.prototype.drawAxes=function(){var t,n,e=this;if((!e._config.xAxis||e._config.xAxis&&!1!==e._config.xAxis.enabled)&&(t=e._svg.append("g").attr("class","x axis").attr("transform","translate(0,"+e._height+")").call(e._axes.x)),(!e._config.yAxis||e._config.yAxis&&!1!==e._config.yAxis.enabled)&&(n=e._svg.append("g").attr("class","y axis").call(e._axes.y)),e._config.xAxis&&e._config.xAxis.text&&t.append("text").attr("class","label title").attr("x",e._width/2).attr("y",e._config.xAxis.y?e._config.xAxis.y:30).style("text-anchor","middle").style("fill",e._config.xAxis.fill?e._config.xAxis.fill:"black").style("font-size",e._config.xAxis["font-size"]?e._config.xAxis["font-size"]:"12px").style("font-weight",e._config.xAxis["font-weight"]?e._config.xAxis["font-weight"]:"600").text(e._config.xAxis.text),e._config.xAxis&&e._config.xAxis.dropdown&&!0===e._config.xAxis.dropdown.enable){d3.select(e._config.bindTo).append("div").attr("class","dbox-xAxis-select").append("select").on("change",function(){e.updateAxis("x",this.value)}).selectAll("option").data(e._config.xAxis.dropdown.options).enter().append("option").attr("value",function(t){return t.value}).text(function(t){return t.title}).property("selected",function(t){return t.selected})}if(e._config.yAxis&&!1!==e._config.yAxis.enabled&&e._config.yAxis&&e._config.yAxis.text&&n.append("text").attr("class","label title").attr("transform","rotate(-90)").attr("y",e._config.yAxis.y?e._config.yAxis.y:-50).attr("x",-150).attr("dy",".71em").style("text-anchor","middle").style("fill",e._config.yAxis.fill?e._config.yAxis.fill:"black").style("font-size",e._config.yAxis["font-size"]?e._config.yAxis["font-size"]:"12px").style("font-weight",e._config.xAxis["font-weight"]?e._config.xAxis["font-weight"]:"600").text(e._config.yAxis.text),e._config.yAxis&&e._config.yAxis.dropdown&&!0===e._config.yAxis.dropdown.enable){d3.select(e._config.bindTo).append("div").attr("class","dbox-yAxis-select").attr("style",function(){return"transform: translate("+(-1*d3.select(e._config.bindTo).node().getBoundingClientRect().width/2+e._chart._margin.left/4)+"px,"+-1*d3.select(e._config.bindTo).node().getBoundingClientRect().height/2+"px) rotate(-90deg);"}).append("select").on("change",function(){e.updateAxis("y",this.value)}).selectAll("option").data(e._config.yAxis.dropdown.options).enter().append("option").attr("value",function(t){return t.value}).text(function(t){return t.title}).property("selected",function(t){return t.selected})}},n.prototype.drawGraphs=function(){var t=this;t.layers.forEach(function(n){n.data(t._data).scales(t._scales).axes(t._axes).domains().draw(),t._scales=n._scales})},n.prototype.dispatch=d3.dispatch("load","change"),n.prototype.mapData=function(t,n){n(null,t)},n.prototype.getDomains=function(t){var n=this,e={},i=[],r="",a=function(t,n){return d3.ascending(t.y,n.y)},o=function(t,n){return d3.ascending(t.x,n.x)};if(n._config.data.sort&&n._config.data.sort.order)switch(n._config.data.sort.order){case"asc":a=function(t,n){return d3.ascending(t.y,n.y)},o=function(t,n){return d3.ascending(t.x,n.x)};break;case"desc":a=function(t,n){return d3.descending(t.y,n.y)},o=function(t,n){return d3.descending(t.x,n.x)}}if(n._config.xAxis&&n._config.xAxis.scale)switch(n._config.xAxis.scale){case"linear":case"time":i=d3.extent(t,function(t){return t.x}),e.x=i;break;case"ordinal":r=n._config.data.sort&&"y"===n._config.data.sort.axis?t.sort(a):t.sort(o),e.x=[],r.forEach(function(t){e.x.push(t.x)});break;case"quantile":r=n._config.data.sort&&"y"===n._config.data.sort.axis?t.sort(a):t.sort(o),e.q=[],r.forEach(function(t){e.q.push(t.x)}),e.x=d3.range(n._config.xAxis.buckets);break;default:i=d3.extent(t,function(t){return t.x}),e.x=i}else i=d3.extent(t,function(t){return t.x}),e.x=i;if(n._config.yAxis&&n._config.yAxis.scale)switch(n._config.yAxis.scale){case"linear":i=d3.extent(t,function(t){return t.y}),i[0]>0&&(i[0]=i[0]-.1*(i[1]-i[0])),e.y=i;break;case"time":i=d3.extent(t,function(t){return t.y}),e.y=i;break;case"ordinal":if(n._config.data.sort&&"y"===n._config.data.sort.axis){var r=t.sort(function(t,n){return d3.ascending(t.y,n.y)});e.y=[],r.forEach(function(t){e.y.push(t.x)})}else e.y=d3.map(t,function(t){return t.y}).keys().sort(function(t,n){return d3.ascending(t,n)});break;default:i=d3.extent(t,function(t){return t.y}),e.y=i}else i=d3.extent(t,function(t){return t.y}),e.y=i;return e},n.prototype.destroy=function(){var t=this;d3.select(t._config.bindTo).html("")},new n(t)},r=function(t){function n(t){var n=this;n._config=t||{},n._data=[],n._config.colorScale=d3.schemeCategory20c,n._config._format=function(t){return t%1==0?d3.format(",.0f")(t):t<1&&t>0?d3.format(",.2f")(t):d3.format(",.1f")(t)},n._scales={},n._axes={},n._tip=d3.tip().attr("class","d3-tip tip-treemap").direction("n").html(n._config.tip||function(t){return n._config._format(t[n._config.y])})}return n.prototype.x=function(t){var n=this;return n._config.x=t,n},n.prototype.y=function(t){var n=this;return n._config.y=t,n},n.prototype.color=function(t){var n=this;return n._config.color=t,n},n.prototype.end=function(){return this._chart},n.prototype.colorScale=function(t){var n=this;return Array.isArray(t)?n._config.colorScale=t:(n._scales.color=t,n._config.colorScale=t.range()),n},n.prototype.format=function(t){var n=this;return"function"==typeof t||t instanceof Function?n._config._format=t:n._config._format=d3.format(t),n},n.prototype.chart=function(t){var n=this;return n._chart=t,n},n.prototype.data=function(t){var n=this;return n._data=t.map(function(t){return t[n._config.x]==Number(t[n._config.x])&&(t[n._config.x]=+t[n._config.x]),t[n._config.y]==Number(t[n._config.y])&&(t[n._config.y]=+t[n._config.y]),t}),n},n.prototype.scales=function(t){var n=this,e={column:n._config.x,type:n._config.xAxis.scale,range:[0,n._chart._width],minZero:!0};return n._scales.x=n._chart.generateScale(n._data,e),e={column:n._config.y,type:n._config.yAxis.scale,range:[n._chart._height,0],minZero:!0},n._scales.y=n._chart.generateScale(n._data,e),n._chart._scales.x=n._scales.x,n._chart._scales.y=n._scales.y,n._scales.color||(n._scales.color=d3.scaleOrdinal(n._config.colorScale)),n},n.prototype.axes=function(t){var n=this;return n._axes=t,n},n.prototype.domains=function(){return this},n.prototype.draw=function(){var t=this;return t._chart._svg.call(t._tip),t._chart._svg.selectAll(".bar").data(t._data).enter().append("rect").attr("class","bar").attr("x",function(n){return"linear"==t._config.xAxis.scale&&"linear"==t._config.yAxis.scale?0:t._scales.x(n[t._config.x])}).attr("y",function(n){return t._scales.y(n[t._config.y])}).attr("width",function(n){return t._scales.x.bandwidth?t._scales.x.bandwidth():t._scales.x(n[t._config.x])}).attr("height",function(n){return t._chart._height-t._scales.y(n[t._config.y])}).attr("fill",function(n){return t._scales.color(n[t._config.color])}).style("opacity",.9).on("mouseover",function(n){t._tip.show(n,d3.select(this).node())}).on("mouseout",function(){t._tip.hide()}).on("click",function(){}),t},new n(t)},a=function(t){function n(t){var n=this;n._config=t||{},n._data=[],n._scales={},n._axes={},n._gridSize=Math.floor(n._config.size.width/16),n._legendElementWidth=n._gridSize,n._config._format=d3.format(",.1f"),n._tip=d3.tip().attr("class","d3-tip")}return n.prototype.x=function(t){var n=this;return n._config.x=t,n},n.prototype.y=function(t){var n=this;return n._config.y=t,n},n.prototype.colors=function(t){var n=this;return n._config.colors=t,n},n.prototype.tip=function(t){var n=this;return n._config.tip=t,n._tip.html(n._config.tip),n},n.prototype.buckets=function(t){var n=this;return n._config.buckets=buckets,n},n.prototype.end=function(){return this._chart},n.prototype.chart=function(t){var n=this;return n._chart=t,n},n.prototype.data=function(t){var n=this;return n._data=t.map(function(t){return{y:t.edad_mujer,x:t.edad_hombre,value:+t.tot,percentage:+t.por}}),n},n.prototype.scales=function(t){var n=this;return n._scales=t,n},n.prototype.axes=function(t){var n=this;return n._axes=t,n},n.prototype.domains=function(){return this},n.prototype.draw=function(){var t=this;t._chart._svg.call(t._tip),t._config.xAxis?t._config.xAxis.y=t._config.y.length*t._gridSize+25:t._config.xAxis={y:t._config.y.length*t._gridSize},t._dayLabels=t._chart._svg.selectAll(".dayLabel").data(t._config.y).enter().append("text").text(function(t){return t}).attr("x",0).attr("y",function(n,e){return e*t._gridSize}).style("text-anchor","end").attr("transform","translate(-6,"+t._gridSize/1.5+")").attr("class","dayLabel mono axis"),t._timeLabels=t._chart._svg.selectAll(".timeLabel").data(t._config.x).enter().append("text").text(function(t){return t}).attr("x",function(n,e){return e*t._gridSize}).attr("y",t._config.xAxis.y).style("text-anchor","middle").attr("transform","translate("+t._gridSize/2+", -6)").attr("class","timeLabel mono axis");var n=d3.scaleQuantile().domain([0,d3.max(t._data,function(t){return t.value})]).range(t._config.colors);return t._chart._svg.selectAll(".hour").data(t._data,function(t){return t.y+":"+t.x}).enter().append("rect").attr("x",function(n){return t._config.x.indexOf(n.x)*t._gridSize}).attr("y",function(n){return t._config.y.indexOf(n.y)*t._gridSize}).attr("rx",4).attr("ry",4).attr("class","hour bordered").attr("id",function(t){return"x"+t.x+"y"+t.y}).attr("width",t._gridSize).attr("height",t._gridSize).on("mouseover",function(n,e){t._tip.show(n,d3.select(this).node())}).on("mouseout",function(n,e){t._tip.hide(n,d3.select(this).node())}).on("click",function(n,e){t._config.data.onclick&&t._config.data.onclick.call(this,n,e)}).style("fill",t._config.colors[0]).transition().duration(3e3).ease(d3.easeLinear).style("fill",function(t){return n(t.value)}),t},new n(t)},o=function(t){function n(t){var n,e=this;e.CIRCLE_RADIANS=2*Math.PI,e.RADIANS_TO_ROTATE=e.CIRCLE_RADIANS/-4,e._config=t||{},e._data=[],e._scales={},e._axes={},e._axesData={},e._filter=null,e._minMax=[0,0],e._viewData=[],e._colorMap={},e._ticks=0,e._scale=null,e._excludedPolygons=[],e._config.ticks||(e._config.ticks=10),e._config.transitionDuration||(e._config.transitionDuration=400),e._config.axisLabelMargin||(e._config.axisLabelMargin=24),e._config.legend||(e._config.legend={enable:!0}),e._config.legend.at||(e._config.legend.at={x:20,y:20}),void 0===e._config.styleDefaults&&(e._config.styleDefaults=!0),n=e._config.size,e._center={x:n.width/2-n.margin.left,y:n.height/2-n.margin.top},e._radius=Math.min((n.width-n.margin.left-n.margin.right)/2,(n.height-n.margin.top-n.margin.bottom)/2)}return n.prototype.polygonsFrom=function(t){var n=this;return n._config.polygonsFrom=t,n},n.prototype.axesFrom=function(t){var n=this;return n._config.axesFrom=t,n},n.prototype.valuesFrom=function(t){var n=this;return n._config.valuesFrom=t,n},n.prototype.ticks=function(t){var n=this;return n._config.ticks=t,n},n.prototype.colors=function(t){var n=this;return n._config.colors=t,n},n.prototype.end=function(){return this._chart},n.prototype.drawTicks=function(){var t,n=this,e=n._chart._svg,i=n._config.transitionDuration;t=e.select("g.ticks"),t.empty()&&(t=e.append("g").attr("class","ticks")),t=t.selectAll("circle.tick").data(n._ticks.map(function(t,n){return[n,t]}).reverse(),function(t){return t[0]}),t.transition().duration(i).attr("r",function(t){return n._scale(t[1])}),t.enter().append("circle").classed("tick",!0).attr("cx",n._center.x).attr("cy",n._center.y).style("fill",n._ifStyleDefaults("none")).style("stroke",n._ifStyleDefaults("gray")).attr("r",function(t){return n._scale(t[1])}).attr("opacity",0).transition().duration(i).attr("opacity",1),t.exit().transition().duration(i).attr("opacity",0).remove()},n.prototype.drawTicksLabels=function(){var t,n=this,e=n._chart._svg,i=n._config.transitionDuration;t=e.select("g.ticks-labels"),t.empty()&&(t=e.append("g").attr("class","ticks-labels")),t=t.selectAll("text.tick-label").data(n._ticks),t.transition().duration(i).text(function(t){return t}).attr("y",function(t){return n._center.y-2-n._scale(t)}),t.enter().append("text").text(function(t){return t}).attr("class","tick-label").attr("x",n._center.x+2).attr("y",function(t){return n._center.y-2-n._scale(t)}).attr("fill",n._ifStyleDefaults("gray")).style("font-family",n._ifStyleDefaults("sans-serif")).attr("opacity",0).transition().duration(i).attr("opacity",1),t.exit().transition().duration(i).attr("opacity",0).remove()},n.prototype.extractAxes=function(t){var n,e,i=this,r=i._config.axesFrom;return n=t.reduce(function(t,n){return t.indexOf(n[r])>-1?t:t.concat(n[r])},[]),e=i.CIRCLE_RADIANS/n.length,n=n.map(function(t,n){return{axis:t,rads:n*e+i.RADIANS_TO_ROTATE}}),{list:n,hash:n.reduce(function(t,n){return t[n.axis]=n,t},{})}},n.prototype.buildColorMap=function(t){var n=this,e=n._config.colors;return t.reduce(function(t,i){var r=i[n._config.polygonsFrom],a=t.index.indexOf(r);return-1==a&&(a=t.index.push(r)-1,t.hash[r]=e[a],t.list.push({polygon:r,color:e[a]})),t},{index:[],hash:{},list:[]})},n.prototype.drawAxes=function(){var t,n=this,e=n._chart._svg,i=n._config.transitionDuration;t=e.selectAll("line.axis").data(n._axesData.list,function(t){return t.axis}),t.enter().append("line").classed("axis",!0).attr("x1",n._center.x).attr("y1",n._center.y).style("stroke",n._ifStyleDefaults("gray")).attr("x2",n._center.x).attr("y2",n._center.y).transition().duration(i).attr("x2",function(t){return n.xOf(t.rads,n._radius+8)}).attr("y2",function(t){return n.yOf(t.rads,n._radius+8)}),t.transition().duration(i).attr("x2",function(t){return n.xOf(t.rads,n._radius+8)}).attr("y2",function(t){return n.yOf(t.rads,n._radius+8)}),t.exit().transition().duration(i).attr("x2",n._center.x).attr("y2",n._center.y).remove()},n.prototype.drawAxesLabels=function(){var t,n=this,e=n._chart._svg,i=n._config.transitionDuration,r=n._radius+n._config.axisLabelMargin;t=e.selectAll("text.axis-label").data(n._axesData.list,function(t){return t.axis}),t.transition().duration(i).attr("x",function(t){return n.xOf(t.rads,r)}).attr("y",function(t){return n.yOf(t.rads,r)}),t.enter().append("text").attr("class","axis-label").attr("text-anchor","middle").attr("fill",n._ifStyleDefaults("gray")).style("font-family",n._ifStyleDefaults("sans-serif")).text(function(t){return t.axis}).attr("x",function(t){return n.xOf(t.rads,r)}).attr("y",function(t){return n.yOf(t.rads,r)}).attr("opacity",0).transition().duration(i).attr("opacity",1),t.exit().transition().duration(i).attr("opacity",0).remove()},n.prototype.drawPolygons=function(){var t,n,e,i,r=this,a=r._viewData,o=r._chart._svg,c=r._config.transitionDuration;t=a.reduce(function(t,n){var e=t.keys.indexOf(n.polygon);return-1==e&&(e=t.keys.push(n.polygon)-1,t.polygons.push({polygon:n.polygon,color:n.color,points:[],values:[]})),t.polygons[e].values.push(n),t.polygons[e].points.push(n.xy.join(",")),t},{keys:[],polygons:[]}).polygons,n=o.selectAll("g.polygon-container").data(t,function(t){return t.polygon+"-container"}),i=n.enter().append("g").attr("class","polygon-container"),e=n.exit(),e.transition().duration(c).remove(),r._buildNestedPolygons(n,i,e),r._buildNestedVertexes(n,i,e)},n.prototype._buildNestedVertexes=function(t,n,e){function i(t){t.append("circle").attr("class","vertex").attr("cx",l._center.x).attr("cy",l._center.y).attr("r",4).attr("fill",function(t){return t.color}).call(a).on("mouseover",function(t){var n=t.xy[0]+10,e=t.xy[1]-10;l._showTooltip(n,e,t.polygon,t.value)}).on("mouseout",function(){l._hideTooltip()})}function r(t){t.transition().duration(f).attr("cx",l._center.x).attr("cy",l._center.y).remove()}function a(t){t.transition().duration(f).attr("cx",function(t){return t.xy[0]}).attr("cy",function(t){return t.xy[1]})}function o(t){return t.values}function c(t){return t.polygon+"-"+t.axis}var s,l=this,f=l._config.transitionDuration;s=t.selectAll("circle.vertex").data(o,c),s.call(a),s.enter().call(i),s.exit().call(r),n.selectAll("circle.vertex").data(o,c).enter().call(i),e.selectAll("circle.vertex").call(r)},n.prototype._showTooltip=function(t,n,e,i){var r,a,o,c,s=this;return r=s._chart._svg.append("g").attr("class","tooltip").attr("opacity",0),o=r.append("rect").attr("class","tooltip-background"),a=r.append("text").attr("y",n).attr("x",t).style("fill",s._ifStyleDefaults("white")).style("font-family",s._ifStyleDefaults("sans-serif")),a.append("tspan").text(i),a.append("tspan").attr("dy","-1.2em").attr("x",t).text(e),c=r.node().getBBox(),o.attr("x",c.x-2).attr("y",c.y-2).attr("width",c.width+4).attr("height",c.height+4).style("fill",s._ifStyleDefaults("gray")),r.transition().duration(200).attr("opacity",.9),r},n.prototype._hideTooltip=function(){this._chart._svg.selectAll("g.tooltip").transition().duration(200).attr("opacity",0).remove()},n.prototype._buildNestedPolygons=function(t,n,e){function i(t){var n=[f._center.x,f._center.y].join(",");return t.points.map(function(){return n}).join(" ")}function r(t){t.append("polygon").attr("class","category").attr("points",i).style("stroke",function(t){return t.color}).style("fill",function(t){return t.color}).style("fill-opacity",.4).style("stroke-width",f._ifStyleDefaults("1px")).call(o)}function a(t){t.transition().duration(u).attr("points",i).remove()}function o(t){t.transition().duration(u).attr("points",function(t){return t.points.join(" ")})}function c(t){return[t]}function s(t){return t.polygon}var l,f=this,u=f._config.transitionDuration,d="polygon.category";l=t.selectAll(d).data(c,s),l.call(o),l.enter().call(r),l.exit().call(a),n.selectAll(d).data(c,s).enter().call(r),e.selectAll(d).call(a)},n.prototype.drawLegend=function(){var t,n,e=this,i=e._colorMap.list,r=e._chart._svg,a=e._config.legend.at;t=r.selectAll("g.legend-item").data(i,function(t){return t.polygon}).attr("opacity",function(t){return e._excludedPolygons.indexOf(t.polygon)>-1?.4:1}),n=t.enter().append("g").on("click",function(t){e._excludedPolygons=e._toggleList(e._excludedPolygons,[t.polygon]),e.draw()}).attr("class","legend-item"),n.append("text").text(function(t){return t.polygon}).attr("x",a.x+14+4).attr("y",function(t,n){return 18*n+a.y+14}).style("font-family",e._ifStyleDefaults("sans-serif")),n.append("rect").attr("fill",function(t){return t.color}).attr("width",14).attr("height",14).attr("x",a.x).attr("y",function(t,n){return 18*n+a.y})},n.prototype._ifStyleDefaults=function(t){return this._config.styleDefaults?t:null},n.prototype._toggleList=function(t,n){var e=n.filter(function(n){return-1==t.indexOf(n)});return t.filter(function(t){return-1==n.indexOf(t)}).concat(e)},n.prototype.xOf=function(t,n){return this._center.x+n*Math.cos(t)},n.prototype.yOf=function(t,n){return this._center.y+n*Math.sin(t)},n.prototype.minMax=function(t){var n=this;return t.reduce(function(t,e){var i=parseInt(e[n._config.valuesFrom]);return 0==t.length?[i,i]:[i<t[0]?i:t[0],i>t[1]?i:t[1]]},[])},n.prototype.dataForVisualization=function(t){var n=this,e=n._scale,i=n._config.axesFrom,r=n._config.valuesFrom,a=n._config.polygonsFrom,o=n._axesData.hash;return t.map(function(t){var c=t[i],s=o[c].rads,l=t[a],f=t[r],u=e(f);return{xy:[n.xOf(s,u),n.yOf(s,u)],value:f,polygon:l,axis:c,color:n._colorMap.hash[l],rawData:t}})},n.prototype.filter=function(t){var n=this;return n._filter=t,n},n.prototype.chart=function(t){var n=this;return n._chart=t,n},n.prototype.data=function(t){var n=this;return n._data=t,n},n.prototype.scales=function(t){var n=this;return n._scales=t,n._scale=n._scales.x,n._scale.range([0,n._radius]),n},n.prototype.axes=function(t){return this},n.prototype.domains=function(){var t=this;return t._calcDomains(t._data),t},n.prototype._calcDomains=function(t){var n=this;n._minMax=n.minMax(t),n._scale.domain([0,n._minMax[1]]),n._ticks=n._scale.ticks(n._config.ticks),n._ticks.length>0&&0===n._ticks[0]&&(n._ticks=n._ticks.slice(1))},n.prototype.draw=function(){var t=this,n=t._data;t._colorMap=t.buildColorMap(n),"function"==typeof t._filter&&(n=n.filter(t._filter)),t._excludedPolygons.length>0&&(n=n.filter(function(n){return-1==t._excludedPolygons.indexOf(n[t._config.polygonsFrom])})),t._calcDomains(n),t._axesData=t.extractAxes(n),t._viewData=t.dataForVisualization(n),t.drawTicks(),t.drawAxes(),t.drawAxesLabels(),t.drawTicksLabels(),t.drawPolygons(),t.drawLegend()},new n(t)},c=function(t){function n(t){var n=this;n._config=t||{},n._data=[],n._scales={},n._axes={},n._tip=d3.tip().attr("class","d3-tip")}return n.prototype.x=function(t){var n=this;return n._config.x=t,n},n.prototype.y=function(t){var n=this;return n._config.y=t,n},n.prototype.radius=function(t){var n=this;return n._config.radius=t,n},n.prototype.radiusRange=function(t){var n=this;return n._config.radiusRange=t,n},n.prototype.properties=function(t){var n=this;return n._config.properties=t,n},n.prototype.color=function(t){var n=this;return n._config.color=t,n},n.prototype.opacity=function(t){var n=this;return n._config.opacity=t,n},n.prototype.tip=function(t){var n=this;return n._config.tip=t,n._tip.html(n._config.tip),n},n.prototype.end=function(){return this._chart},n.prototype.chart=function(t){var n=this;return n._chart=t,n},n.prototype.data=function(t){var n=this;return n._data=[],t.forEach(function(t,e){var i={};i.datum=t,i.x="linear"==n._config.xAxis.scale?+t[n._config.x]:t[n._config.x],i.y="linear"==n._config.yAxis.scale?+t[n._config.y]:t[n._config.y],i.color="#"!==n._config.color.slice(0,1)?t[n._config.color]:n._config.color,i.radius=void 0!==n._config.radius?isNaN(n._config.radius)?+t[n._config.radius]:n._config.radius:5,void 0!==n._config.properties&&Array.isArray(n._config.properties)&&n._config.properties.length>0&&n._config.properties.forEach(function(n){i[n]=t[n]}),n._data.push(i)}),n},n.prototype.scales=function(t){var n=this;return n._scales=t,n},n.prototype.axes=function(t){var n=this;return n._axes=t,n},n.prototype.domains=function(){var t=this,n=d3.extent(t._data,function(t){return t.x}),e=d3.extent(t._data,function(t){return t.y}),i=d3.extent(t._data,function(t){return t.radius}),r=[0,0];return t._config.fixTo45?(n[1]>e[1]?r[1]=n[1]:r[1]=e[1],n[0]<e[0]?r[0]=n[0]:r[0]=e[0],t._scales.x.domain(r).nice(),t._scales.y.domain(r).nice(),t._scales.radius=d3.scaleLinear().range(void 0!=t._config.radiusRange?t._config.radiusRange:[5,15]).domain(i).nice()):(t._scales.x.domain(n),t._scales.y.domain(e),t._scales.x.nice&&t._scales.x.nice(),t._scales.y.nice&&t._scales.y.nice(),t._scales.radius=d3.scaleLinear().range(void 0!=t._config.radiusRange?t._config.radiusRange:[5,15]).domain(i).nice(),t._config.xAxis&&"linear"!==t._config.xAxis.scale&&t._scales.x.domain(t._data.map(function(t){return t.x})),t._config.yAxis&&"linear"!==t._config.yAxis.scale&&t._scales.y.domain(t._data.map(function(t){return t.y}))),t._config.xAxis.scaleDomain&&Array.isArray(t._config.xAxis.scaleDomain)&&t._scales.x.domain(t._config.xAxis.scaleDomain),t._config.yAxis.scaleDomain&&Array.isArray(t._config.yAxis.scaleDomain)&&t._scales.y.domain(t._config.yAxis.scaleDomain),t},n.prototype.draw=function(){var t=this;t._chart._svg.call(t._tip);t._chart._svg.selectAll(".dot").data(t._data).enter().append("circle").attr("class","dot").attr("class",function(t,n){return void 0!==t.properties&&void 0!==t.properties.id?"scatter-"+t.properties.id:"scatter-"+n}).attr("r",function(n){return t._scales.radius(n.radius)}).attr("cx",function(n){return"ordinal"==t._config.xAxis.scale||"band"==t._config.xAxis.scale?t._scales.x(n.x)+Math.random()*(t._scales.x.bandwidth()-2*n.size):t._scales.x(n.x)}).attr("cy",function(n){return"ordinal"==t._config.yAxis.scale||"band"==t._config.yAxis.scale?t._scales.y(n.y)+Math.random()*(t._scales.y.bandwidth()-2*n.size):t._scales.y(n.y)}).style("fill",function(n){return"#"!==n.color.slice(0,1)?t._scales.color(n.color):n.color}).style("opacity",void 0!==t._config.opacity?t._config.opacity:1).on("mouseover",function(n,e){t._config.mouseover&&t._config.mouseover.call(t,n,e),t._tip.show(n,d3.select(this).node())}).on("mouseout",function(n,e){t._config.mouseout&&t._config.mouseout.call(this,n,e),t._tip.hide(n,d3.select(this).node())}).on("click",function(n,e){t._config.onclick&&t._config.onclick.call(this,n,e)});return t},n.prototype.select=function(t){return this._chart._svg.select("circle.scatter-"+t)},n.prototype.selectAll=function(t){return this._chart._svg.selectAll("circle")},new n(t)},s=function(t){function n(t){var n=this;n._config=t||{},n._data=[],n._scales={},n._axes={},n._line=d3.line().curve(d3.curveBasis).x(function(t){return n._scales.x(t.x)}).y(function(t){return n._scales.y(t.y)}),n._area=d3.area().curve(d3.curveBasis).x(function(t){return t.alreadyScaled&&!0===t.alreadyScaled?t.x:n._scales.x(t.x)}).y1(function(t){return t.alreadyScaled&&!0===t.alreadyScaled?t.y:n._scales.y(t.y)})}var e=d3.timeParse("%Y-%m-%d");return n.prototype.x=function(t){var n=this;return n._config.x=t,n},n.prototype.y=function(t){var n=this;return n._config.y=t,n},n.prototype.series=function(t){var n=this;return n._config.series=t,n},n.prototype.color=function(t){var n=this;return n._config.color=t,n},n.prototype.end=function(){return this._chart},n.prototype.chart=function(t){var n=this;return n._chart=t,n},n.prototype.data=function(t){var n=this
;return n._data=t.map(function(t){return t.x=e(t[n._config.x]),t.color=t[n._config.color],delete t[n._config.x],t}),n._lines=n._config.y?n._config.y:n._config.series,n._lines=n._lines.map(function(n){return{name:n,values:t.map(function(t){return{x:t.x,y:+t[n]}})}}),n},n.prototype.scales=function(t){var n=this;return n._scales=t,n},n.prototype.axes=function(t){var n=this;return n._axes=t,n},n.prototype.domains=function(){var t=this;return t._xMinMax=d3.extent(t._data,function(t){return t.x}),t._yMinMax=[d3.min(t._lines,function(t){return d3.min(t.values,function(t){return t.y})}),d3.max(t._lines,function(t){return d3.max(t.values,function(t){return t.y})})],t._scales.x.domain(t._xMinMax),t._scales.y.domain(t._yMinMax),console.log(t._scales.x.domain(),t._chart._scales.x.domain()),t._chart._scales=t._scales,t},n.prototype.draw=function(){var t=this,n=(t._chart._svg.selectAll(".lines").data(t._lines).enter().append("g").attr("class","lines"),t._chart._svg.selectAll(".lines").append("path").attr("class","line").attr("d",function(n){return t._line(n.values)}).style("stroke",function(t){return"Airbus"==t.name?"rgb(000,255,000)":"#000"}),textures.lines().thicker());t._chart._svg.call(n),t._area.y0(t._scales.y(t._yMinMax[0]));t._chart._svg.selectAll(".areas").data(t._lines).enter().append("g").attr("class","areas"),t._chart._svg.selectAll(".areas").append("path").attr("class","area").attr("d",function(n){return t._area(n.values)}).attr("fill",n.url());return t},new n(t)},l=function(t){function n(t){var n=this;n._config=t||{},n._config._padding=3,n._config._colorScale=d3.scaleOrdinal(d3.schemeCategory20c),n._config._format=d3.format(",.1f"),n._config._labels=!0,n._config.tip=function(t){return t.data.name+"\n"+n._config._format(t.value)},n._data=[],n._scales={},n._axes={},n._tip=d3.tip().attr("class","d3-tip tip-treemap").direction("n").html(n._config.tip)}function e(t,n,e){e(null,t.key(function(t){return t[n]}))}return n.prototype.end=function(){return this._chart},n.prototype.size=function(t){var n=this;return n._config._size=t,n},n.prototype.colorScale=function(t){var n=this;return n._config._colorScale=d3.scaleOrdinal(t),n},n.prototype.padding=function(t){var n=this;return n._config._padding=t,n},n.prototype.nestBy=function(t){var n=this;if(Array.isArray(t)){if(0==t.length)throw"Error: nestBy() array is empty";n._config._keys=t}else if("string"==typeof t||t instanceof String)n._config._keys=[t];else{if(void 0==t||null==t)throw"Error: nestBy() expects column names to deaggregate data";n._config._keys=[t.toString()],console.warning("nestBy() expected name of columns. Argument will be forced to string version .toString()")}return n._config._labelName=n._config._keys[n._config._keys.length-1],n},n.prototype.format=function(t){var n=this;return"function"==typeof t||t instanceof Function?n._config._format=t:n._config._format=d3.format(t),n},n.prototype.labels=function(t){var n=this;return n._config._labels=Boolean(t),n},n.prototype.tip=function(t){var n=this;return n._config.tip=t,n._tip.html(n._config.tip),n},n.prototype.chart=function(t){var n=this;return n._chart=t,n},n.prototype.scales=function(){return this},n.prototype.axes=function(){return this},n.prototype.domains=function(){return this},n.prototype.isValidStructure=function(t){var n=this;if(("string"==typeof t.name||t.name instanceof String)&&Array.isArray(t.children)){var e=!0;return t.children.forEach(function(t){e=e&&n.isValidStructure(t)}),e}return("string"==typeof t.name||t.name instanceof String)&&Number(t[n._config._size])==t[n._config._size]},n.prototype.formatNestedData=function(t){var n=this;if(t.key?(t.name=t.key,delete t.key):Array.isArray(t.values)||(t.name=t[n._config._labelName]),Array.isArray(t.values)){var e=[];t.values.forEach(function(t){e.push(n.formatNestedData(t))}),t.children=e,delete t.values}return!t[n._config._size]&&t.value&&(t[n._config._size]=t.value),t},n.prototype.data=function(t){var n=this;if(t)if(Array.isArray(t)&&t.length>0){if(!n.isValidStructure(t[0])){t.forEach(function(t){t[n._config._size]=+t[n._config._size]});try{if(!n._config._keys)throw"nestBy() in layer was not configured";for(var i=d3.nest(),r=d3.queue(),a=0;a<n._config._keys.length;a++)r.defer(e,i,n._config._keys[a]);r.awaitAll(function(e,i){var r=i[0].rollup(function(t){return d3.sum(t,function(t){return t[n._config._size]})}).entries(t),a={};a.key="data",a.values=_.cloneDeep(r),t=n.formatNestedData(a),n._data=t})}catch(t){console.error(t)}}}else if(!n.isValidStructure(t))try{if(!t.key)throw"Property 'key' not found";if(t[n._config._size]!==Number(t[n._config._size]))throw"Value used for treemap rect size is not a number";t=n.formatNestedData(t),n._data=t}catch(t){console.error(t)}return n},n.prototype.draw=function(){var t=this;t._chart._svg.call(t._tip);var n=d3.treemap().tile(d3.treemapResquarify).size([t._chart._width,t._chart._height]).round(!0).paddingInner(t._config._padding),e=d3.hierarchy(t._data).eachBefore(function(t){t.data.id=(t.parent?t.parent.data.id+".":"")+t.data.name}).sum(function(n){return n[t._config._size]}).sort(function(t,n){return n.height-t.height||n.value-t.value});n(e);var i=t._chart._svg.selectAll("g").data(e.leaves()).enter().append("g").attr("transform",function(t){return"translate("+t.x0+","+t.y0+")"}),r=i.append("rect").attr("id",function(t){return t.data.id}).attr("width",function(t){return t.x1-t.x0}).attr("height",function(t){return t.y1-t.y0}).attr("fill",function(n){return t._config._colorScale(n.data.id)});if(i.append("clipPath").attr("id",function(t){return"clip-"+t.data.id}).append("use").attr("xlink:href",function(t){return"#"+t.data.id}),t._config._labels){var a=i.append("text").attr("clip-path",function(t){return"url(#clip-"+t.data.id+")"});a.append("tspan").attr("class","capitalize").attr("x",8).attr("y",25).text(function(t){if(t.value>2){var n=t.data.id.replace("data.","").split(".");return n.length>1?n.slice(n.length-2,n.length).join(" / "):n[n.length-1].toString()}return""}),a.append("tspan").attr("class","capitalize").attr("x",8).attr("y",45).text(function(n){return n.value>2?t._config._format(n.value):""})}return r.on("mouseover",function(n){t._tip.show(n,d3.select(this).node())}).on("mouseout",function(n){t._tip.hide(n,d3.select(this).node())}),t},new n(t)};t.chart=i,t.bars=r,t.heatmap=a,t.radar=o,t.scatter=c,t.timeline=s,t.treemap=l,Object.defineProperty(t,"__esModule",{value:!0})});